import json
import pandas as pd # Para manejar el csv

data = pd.read_csv('/scratch/padchest2/labels_csv/PADCHEST_chest_x_ray_images_labels_160K_01.02.19.csv')
data = data[data.Projection == "PA"]    # Me quedo solo con las filas cuya proyeccion sea PA
data = data[['Report', 'Labels', 'ImageID', "ImageDir"]]
data['File_name'] = data["ImageDir"].astype(str) + "/" + data["ImageID"]
data = data[['Report', 'Labels', 'File_name']]
data = data.dropna()





d_padre_hijo = {"Pulmon": ["multiple nodules", "nodule", "end on vessel", "pseudonodule", "nipple shadow", "cyst", "cavitation", "fibrotic band", "volume loss", "bullas", "hypoexpansion", "lung vascular paucity", "air trapping", "bronchiectasis", "atelectasis", "round atelectasis", "laminar atelectasis", "atelectasis basa", "segmental atelectasis", "total atelectasis", "lobar atelectasis", "air bronchogram", "alveolar pattern", "reticular interstitial pattern", "consolidation", "interstitial pattern", "infiltrates", "miliary opacities", "reticulonodular interstitial pattern", "ground glass pattern", "azygos lobe", "vascular redistribution", "central vascular redistribution", "kerley lines", "pulmonary mass", "atypical pneumonia", "pneumonia", "tuberculosis sequelae", "tuberculosis", "lung metastasis", "pulmonary fibrosis", "post radiotherapy changes", "asbestosis signs", "emphysema", "COPD signs", "heart insufficiency", "pulmonary edema", "respiratory distress", "pulmonary hypertension", "bone metastasis", "bronchovascular markings", "increased density"], "Calcifiacion": ["pleural plaques", "calcified adenopathy", "heart valve calcified", "calcified pleural plaques", "calcified pleural thickening", "calcified densities", "calcified granuloma", "aortic atheromatosis"], "Cuerpos extranos": ["tracheostomy tube", "endotracheal tube", "NSG tube", "chest drain tube", "ventriculoperitoneal drain tube", "central venous catheter", "catheter", "central venous catheter via subclavian vein", "central venous catheter via umbilical vein", "central venous catheter via jugular vein", "reservoir central venous catheter", "electrical device", "pacemaker", "dai", "dual chamber device", "single chamber device", "artificial aortic heart valve", "artificial mitral heart valve", "artificial heart valve", "mammary prosthesis", "sternotomy", "surgery breast", "mastectomy", "bone cement", "surgery neck", "suture material", "humeral prosthesis", "endoprosthesis", "prosthesis", "osteosynthesis material", "surgery humeral", "surgery", "surgery heart", "surgery lung", "metal", "aortic endoprosthesis", "abnormal foreign body", "external foreign body"], "Mediastino e hilios pulmonares": ["pneumomediastinum", "mediastinal shift", "adenopathy", "pulmonary artery enlargement", "hilar enlargement", "vascular hilar enlargement", "hilar congestion", "cardiomegaly", "dextrocardia", "pericardial effusion", "right sided aortic arch", "aortic button enlargement", "supra aortic elongation", "ascendent aortic elongation", "descendent aortic elongation", "aortic elongation", "aortic aneurysm", "mediastinal enlargement", "mediastinal mass", "superior mediastinal enlargement", "goiter", "hiatal hernia", "supra aortic elongation ", "tracheal shift", "esophagic dilatation", "azygoesophageal recess shift", "mediastinic lipomatosis"], "Pleura, diafragma y pared abdominal": ["pneumothorax", "pneumoperitoneo", "subcutaneous emphysema", "flattened diaphragm", "loculated fissural effusion", "fissure thickening", "minor fissure thickening", "major fissure thickening", "pleural thickening", "apical pleural thickening", "pleural effusion", "hydropneumothorax", "loculated pleural effusion", "costophrenic angle blunting", "breast mass", "pleural mass", "soft tissue mass", "pectum carinatum", "scoliosis", "pectum excavatum", "thoracic cage deformation", "cervical rib", "kyphosis", "vertebral degenerative changes", "lytic bone lesion", "sclerotic bone lesion", "costochondral junction hypertrophy", "sternoclavicular junction hypertrophy", "axial hyperostosis", "osteopenia", "osteoporosis", "non axial articular degenerative changes", "subacromial space narrowing", "clavicle fracture", "humeral fracture", "fracture", "rib fracture", "vertebral fracture", "callus rib fracture", "gynecomastia", "Chilaiditi sign", "diaphragmatic eventration", "hemidiaphragm elevation"]}



d_hijo_padre = {"multiple nodules": ["Pulmon"], "nodule": ["Pulmon"], "end on vessel": ["Pulmon"], "pseudonodule": ["Pulmon"], "nipple shadow": ["Pulmon"], "cyst": ["Pulmon"], "cavitation": ["Pulmon"], "fibrotic band": ["Pulmon"], "volume loss": ["Pulmon"], "bullas": ["Pulmon"], "hypoexpansion": ["Pulmon"], "lung vascular paucity": ["Pulmon"], "air trapping": ["Pulmon"], "bronchiectasis": ["Pulmon"], "atelectasis": ["Pulmon"], "round atelectasis": ["Pulmon"], "laminar atelectasis": ["Pulmon"], "atelectasis basa": ["Pulmon"], "segmental atelectasis": ["Pulmon"], "total atelectasis": ["Pulmon"], "lobar atelectasis": ["Pulmon"], "air bronchogram": ["Pulmon"], "alveolar pattern": ["Pulmon"], "reticular interstitial pattern": ["Pulmon"], "consolidation": ["Pulmon"], "interstitial pattern": ["Pulmon"], "infiltrates": ["Pulmon"], "miliary opacities": ["Pulmon"], "reticulonodular interstitial pattern": ["Pulmon"], "ground glass pattern": ["Pulmon"], "azygos lobe": ["Pulmon"], "vascular redistribution": ["Pulmon"], "central vascular redistribution": ["Pulmon"], "kerley lines": ["Pulmon"], "pulmonary mass": ["Pulmon"], "atypical pneumonia": ["Pulmon"], "pneumonia": ["Pulmon"], "tuberculosis sequelae": ["Pulmon"], "tuberculosis": ["Pulmon"], "lung metastasis": ["Pulmon"], "pulmonary fibrosis": ["Pulmon"], "post radiotherapy changes": ["Pulmon"], "asbestosis signs": ["Pulmon"], "emphysema": ["Pulmon"], "COPD signs": ["Pulmon"], "heart insufficiency": ["Pulmon"], "pulmonary edema": ["Pulmon"], "respiratory distress": ["Pulmon"], "pulmonary hypertension": ["Pulmon"], "bone metastasis": ["Pulmon"], "bronchovascular markings": ["Pulmon"], "increased density": ["Pulmon"], "pleural plaques": ["Calcifiacion"], "calcified adenopathy": ["Calcifiacion"], "heart valve calcified": ["Calcifiacion"], "calcified pleural plaques": ["Calcifiacion"], "calcified pleural thickening": ["Calcifiacion"], "calcified densities": ["Calcifiacion"], "calcified granuloma": ["Calcifiacion"], "aortic atheromatosis": ["Calcifiacion"], "tracheostomy tube": ["Cuerpos extranos"], "endotracheal tube": ["Cuerpos extranos"], "NSG tube": ["Cuerpos extranos"], "chest drain tube": ["Cuerpos extranos"], "ventriculoperitoneal drain tube": ["Cuerpos extranos"], "central venous catheter": ["Cuerpos extranos"], "catheter": ["Cuerpos extranos"], "central venous catheter via subclavian vein": ["Cuerpos extranos"], "central venous catheter via umbilical vein": ["Cuerpos extranos"], "central venous catheter via jugular vein": ["Cuerpos extranos"], "reservoir central venous catheter": ["Cuerpos extranos"], "electrical device": ["Cuerpos extranos"], "pacemaker": ["Cuerpos extranos"], "dai": ["Cuerpos extranos"], "dual chamber device": ["Cuerpos extranos"], "single chamber device": ["Cuerpos extranos"], "artificial aortic heart valve": ["Cuerpos extranos"], "artificial mitral heart valve": ["Cuerpos extranos"], "artificial heart valve": ["Cuerpos extranos"], "mammary prosthesis": ["Cuerpos extranos"], "sternotomy": ["Cuerpos extranos"], "surgery breast": ["Cuerpos extranos"], "mastectomy": ["Cuerpos extranos"], "bone cement": ["Cuerpos extranos"], "surgery neck": ["Cuerpos extranos"], "suture material": ["Cuerpos extranos"], "humeral prosthesis": ["Cuerpos extranos"], "endoprosthesis": ["Cuerpos extranos"], "prosthesis": ["Cuerpos extranos"], "osteosynthesis material": ["Cuerpos extranos"], "surgery humeral": ["Cuerpos extranos"], "surgery": ["Cuerpos extranos"], "surgery heart": ["Cuerpos extranos"], "surgery lung": ["Cuerpos extranos"], "metal": ["Cuerpos extranos"], "aortic endoprosthesis": ["Cuerpos extranos"], "abnormal foreign body": ["Cuerpos extranos"], "external foreign body": ["Cuerpos extranos"], "pneumomediastinum": ["Mediastino e hilios pulmonares"], "mediastinal shift": ["Mediastino e hilios pulmonares"], "adenopathy": ["Mediastino e hilios pulmonares"], "pulmonary artery enlargement": ["Mediastino e hilios pulmonares"], "hilar enlargement": ["Mediastino e hilios pulmonares"], "vascular hilar enlargement": ["Mediastino e hilios pulmonares"], "hilar congestion": ["Mediastino e hilios pulmonares"], "cardiomegaly": ["Mediastino e hilios pulmonares"], "dextrocardia": ["Mediastino e hilios pulmonares"], "pericardial effusion": ["Mediastino e hilios pulmonares"], "right sided aortic arch": ["Mediastino e hilios pulmonares"], "aortic button enlargement": ["Mediastino e hilios pulmonares"], "supra aortic elongation": ["Mediastino e hilios pulmonares"], "ascendent aortic elongation": ["Mediastino e hilios pulmonares"], "descendent aortic elongation": ["Mediastino e hilios pulmonares"], "aortic elongation": ["Mediastino e hilios pulmonares"], "aortic aneurysm": ["Mediastino e hilios pulmonares"], "mediastinal enlargement": ["Mediastino e hilios pulmonares"], "mediastinal mass": ["Mediastino e hilios pulmonares"], "superior mediastinal enlargement": ["Mediastino e hilios pulmonares"], "goiter": ["Mediastino e hilios pulmonares"], "hiatal hernia": ["Mediastino e hilios pulmonares"], "supra aortic elongation ": ["Mediastino e hilios pulmonares"], "tracheal shift": ["Mediastino e hilios pulmonares"], "esophagic dilatation": ["Mediastino e hilios pulmonares"], "azygoesophageal recess shift": ["Mediastino e hilios pulmonares"], "mediastinic lipomatosis": ["Mediastino e hilios pulmonares"], "pneumothorax": ["Pleura, diafragma y pared abdominal"], "pneumoperitoneo": ["Pleura, diafragma y pared abdominal"], "subcutaneous emphysema": ["Pleura, diafragma y pared abdominal"], "flattened diaphragm": ["Pleura, diafragma y pared abdominal"], "loculated fissural effusion": ["Pleura, diafragma y pared abdominal"], "fissure thickening": ["Pleura, diafragma y pared abdominal"], "minor fissure thickening": ["Pleura, diafragma y pared abdominal"], "major fissure thickening": ["Pleura, diafragma y pared abdominal"], "pleural thickening": ["Pleura, diafragma y pared abdominal"], "apical pleural thickening": ["Pleura, diafragma y pared abdominal"], "pleural effusion": ["Pleura, diafragma y pared abdominal"], "hydropneumothorax": ["Pleura, diafragma y pared abdominal"], "loculated pleural effusion": ["Pleura, diafragma y pared abdominal"], "costophrenic angle blunting": ["Pleura, diafragma y pared abdominal"], "breast mass": ["Pleura, diafragma y pared abdominal"], "pleural mass": ["Pleura, diafragma y pared abdominal"], "soft tissue mass": ["Pleura, diafragma y pared abdominal"], "pectum carinatum": ["Pleura, diafragma y pared abdominal"], "scoliosis": ["Pleura, diafragma y pared abdominal"], "pectum excavatum": ["Pleura, diafragma y pared abdominal"], "thoracic cage deformation": ["Pleura, diafragma y pared abdominal"], "cervical rib": ["Pleura, diafragma y pared abdominal"], "kyphosis": ["Pleura, diafragma y pared abdominal"], "vertebral degenerative changes": ["Pleura, diafragma y pared abdominal"], "lytic bone lesion": ["Pleura, diafragma y pared abdominal"], "sclerotic bone lesion": ["Pleura, diafragma y pared abdominal"], "costochondral junction hypertrophy": ["Pleura, diafragma y pared abdominal"], "sternoclavicular junction hypertrophy": ["Pleura, diafragma y pared abdominal"], "axial hyperostosis": ["Pleura, diafragma y pared abdominal"], "osteopenia": ["Pleura, diafragma y pared abdominal"], "osteoporosis": ["Pleura, diafragma y pared abdominal"], "non axial articular degenerative changes": ["Pleura, diafragma y pared abdominal"], "subacromial space narrowing": ["Pleura, diafragma y pared abdominal"], "clavicle fracture": ["Pleura, diafragma y pared abdominal"], "humeral fracture": ["Pleura, diafragma y pared abdominal"], "fracture": ["Pleura, diafragma y pared abdominal"], "rib fracture": ["Pleura, diafragma y pared abdominal"], "vertebral fracture": ["Pleura, diafragma y pared abdominal"], "callus rib fracture": ["Pleura, diafragma y pared abdominal"], "gynecomastia": ["Pleura, diafragma y pared abdominal"], "Chilaiditi sign": ["Pleura, diafragma y pared abdominal"], "diaphragmatic eventration": ["Pleura, diafragma y pared abdominal"], "hemidiaphragm elevation": ["Pleura, diafragma y pared abdominal"]}




set_hijos = set()
for padre in d_padre_hijo.keys():
    set_hijos = set_hijos.union(d_padre_hijo[padre])
    
    
    
borrar_indices = []
for index, row in data.iterrows():
    fila = row["Labels"]
    if isinstance(fila,str):
        borrar = True
        etiquetas = fila[1:-1].replace("'","").split(",")
        nuevo = set()
        for enfermedad in etiquetas:
            if len(enfermedad) > 1:
                #print("Labels: " , fila, "enfermedad:", enfermedad, ". len:", len(enfermedad))
                if enfermedad[0] == " ":
                    enfermedad = enfermedad[1:]
                if enfermedad[-1] == " ":
                    enfermedad = enfermedad[:-1]
                if enfermedad in set_hijos:
                    nuevo = nuevo.union(d_hijo_padre[enfermedad])
                    borrar = False
        if borrar:
            borrar_indices.append(index)
        else:
            nuevo = list(nuevo)
            data.at[index, "Labels"] = nuevo
    else:
        borrar_indices.append(index)
        
data.drop(borrar_indices, inplace = True)        


d_frecuencias = {}
for row in data["Labels"]:
    for enfermedad in row:
        if enfermedad in d_frecuencias.keys():
            d_frecuencias[enfermedad] += 1
        else:
            d_frecuencias[enfermedad] = 1

d_frecuencias = {k: v for k, v in sorted(d_frecuencias.items(), key=lambda item: item[1])}        
